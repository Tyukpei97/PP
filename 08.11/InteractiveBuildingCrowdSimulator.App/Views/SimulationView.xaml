<UserControl x:Class="InteractiveBuildingCrowdSimulator.App.Views.SimulationView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:InteractiveBuildingCrowdSimulator.App.ViewModels"
             mc:Ignorable="d"
             d:DesignHeight="720" d:DesignWidth="1040">
    <UserControl.Resources>
        <vm:DoorCoordinateConverter x:Key="DoorCoordinateConverter" />
        <vm:ColorToBrushConverter x:Key="ColorToBrushConverter" />
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <Border Background="#111827" Padding="8" BorderBrush="#1F2937" BorderThickness="0 0 0 1">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="Сценарий:" VerticalAlignment="Center" Margin="0 0 6 0" />
                <ComboBox Width="180"
                          ItemsSource="{Binding Scenarios}"
                          SelectedItem="{Binding SelectedScenario}"
                          DisplayMemberPath="Title"
                          Margin="0 0 8 0" />
                <TextBlock Text="Агентов:" VerticalAlignment="Center" Margin="0 0 4 0" />
                <TextBox Width="60" Text="{Binding Settings.AgentCount}" Margin="0 0 8 0" />
                <TextBlock Text="Скорость (мин/макс):" VerticalAlignment="Center" Margin="0 0 4 0" />
                <TextBox Width="50" Text="{Binding Settings.MinSpeed}" Margin="0 0 4 0" />
                <TextBox Width="50" Text="{Binding Settings.MaxSpeed}" Margin="0 0 8 0" />
                <TextBlock Text="Стресс (мин/макс):" VerticalAlignment="Center" Margin="0 0 4 0" />
                <TextBox Width="50" Text="{Binding Settings.MinStress}" Margin="0 0 4 0" />
                <TextBox Width="50" Text="{Binding Settings.MaxStress}" Margin="0 0 8 0" />
                <TextBlock Text="Масштаб:" VerticalAlignment="Center" Margin="0 0 4 0" />
                <Slider x:Name="ZoomSlider" Minimum="5" Maximum="20" Width="120" Value="10" Margin="0 0 8 0" />
                <Button Content="Старт" Command="{Binding StartCommand}" />
                <Button Content="Пауза" Command="{Binding PauseCommand}" />
                <Button Content="Сброс" Command="{Binding ResetCommand}" />
            </StackPanel>
        </Border>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="3*" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <Border Background="#0B1222" Margin="0 0 8 0" ClipToBounds="True">
                <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                    <Canvas x:Name="SimulationCanvas"
                            Background="#0B1222"
                            Width="1200" Height="900"
                            MouseLeftButtonDown="SimulationCanvas_OnMouseLeftButtonDown">
                        <Canvas.LayoutTransform>
                            <ScaleTransform ScaleX="{Binding Value, ElementName=ZoomSlider}" ScaleY="{Binding Value, ElementName=ZoomSlider}" />
                        </Canvas.LayoutTransform>

                        <ItemsControl ItemsSource="{Binding Map.Corridors}">
                            <ItemsControl.ItemContainerStyle>
                                <Style TargetType="ContentPresenter">
                                    <Setter Property="Canvas.Left" Value="{Binding Bounds.X}" />
                                    <Setter Property="Canvas.Top" Value="{Binding Bounds.Y}" />
                                </Style>
                            </ItemsControl.ItemContainerStyle>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Rectangle Width="{Binding Bounds.Width}"
                                               Height="{Binding Bounds.Height}"
                                               Fill="#1E3A8A"
                                               Stroke="#60A5FA"
                                               StrokeThickness="1.5"
                                               RadiusX="2" RadiusY="2"
                                               Opacity="0.65" />
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <ItemsControl ItemsSource="{Binding Map.Rooms}">
                            <ItemsControl.ItemContainerStyle>
                                <Style TargetType="ContentPresenter">
                                    <Setter Property="Canvas.Left" Value="{Binding Bounds.X}" />
                                    <Setter Property="Canvas.Top" Value="{Binding Bounds.Y}" />
                                </Style>
                            </ItemsControl.ItemContainerStyle>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Width="{Binding Bounds.Width}"
                                            Height="{Binding Bounds.Height}"
                                            Background="#22C55E33"
                                            BorderBrush="#22C55E"
                                            BorderThickness="1.5"
                                            CornerRadius="2">
                                        <TextBlock Text="{Binding Name}"
                                                   Foreground="White"
                                                   FontSize="12"
                                                   VerticalAlignment="Center"
                                                   HorizontalAlignment="Center" />
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <ItemsControl ItemsSource="{Binding Map.Stairs}">
                            <ItemsControl.ItemContainerStyle>
                                <Style TargetType="ContentPresenter">
                                    <Setter Property="Canvas.Left" Value="{Binding Bounds.X}" />
                                    <Setter Property="Canvas.Top" Value="{Binding Bounds.Y}" />
                                </Style>
                            </ItemsControl.ItemContainerStyle>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Width="{Binding Bounds.Width}"
                                            Height="{Binding Bounds.Height}"
                                            Background="#F59E0B33"
                                            BorderBrush="#FBBF24"
                                            BorderThickness="1.5"
                                            CornerRadius="2" />
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <ItemsControl ItemsSource="{Binding Map.Doors}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Line Stroke="#FACC15" StrokeThickness="2" StrokeDashArray="4 2">
                                        <Line.X1>
                                            <MultiBinding Converter="{StaticResource DoorCoordinateConverter}" ConverterParameter="FromX">
                                                <Binding />
                                                <Binding RelativeSource="{RelativeSource AncestorType=UserControl}" Path="DataContext" />
                                            </MultiBinding>
                                        </Line.X1>
                                        <Line.Y1>
                                            <MultiBinding Converter="{StaticResource DoorCoordinateConverter}" ConverterParameter="FromY">
                                                <Binding />
                                                <Binding RelativeSource="{RelativeSource AncestorType=UserControl}" Path="DataContext" />
                                            </MultiBinding>
                                        </Line.Y1>
                                        <Line.X2>
                                            <MultiBinding Converter="{StaticResource DoorCoordinateConverter}" ConverterParameter="ToX">
                                                <Binding />
                                                <Binding RelativeSource="{RelativeSource AncestorType=UserControl}" Path="DataContext" />
                                            </MultiBinding>
                                        </Line.X2>
                                        <Line.Y2>
                                            <MultiBinding Converter="{StaticResource DoorCoordinateConverter}" ConverterParameter="ToY">
                                                <Binding />
                                                <Binding RelativeSource="{RelativeSource AncestorType=UserControl}" Path="DataContext" />
                                            </MultiBinding>
                                        </Line.Y2>
                                    </Line>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <ItemsControl ItemsSource="{Binding Agents}">
                            <ItemsControl.ItemContainerStyle>
                                <Style TargetType="ContentPresenter">
                                    <Setter Property="Canvas.Left" Value="{Binding Position.X}" />
                                    <Setter Property="Canvas.Top" Value="{Binding Position.Y}" />
                                </Style>
                            </ItemsControl.ItemContainerStyle>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Ellipse Width="0.7" Height="0.7"
                                             Fill="{Binding Color, Converter={StaticResource ColorToBrushConverter}}"
                                             Stroke="White" StrokeThickness="0.05"
                                             ToolTip="{Binding Id}" />
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Canvas>
                </ScrollViewer>
            </Border>

            <Border Grid.Column="1" Background="#111827" Padding="12">
                <StackPanel>
                    <TextBlock Text="Мониторинг" FontSize="16" FontWeight="Bold" />
                    <TextBlock Text="{Binding Status}" TextWrapping="Wrap" Margin="0 6 0 0" />
                    <Separator Margin="0 8 0 8" />
                    <TextBlock Text="Выбранный агент" FontWeight="SemiBold" />
                    <TextBlock Text="{Binding SelectedAgent.Id, StringFormat=ID {0}}" />
                    <TextBlock Text="{Binding SelectedAgent.State, StringFormat=Состояние: {0}}" />
                    <TextBlock Text="{Binding SelectedAgent.Position.X, StringFormat=X: {0:0.0}}" />
                    <TextBlock Text="{Binding SelectedAgent.Position.Y, StringFormat=Y: {0:0.0}}" />
                    <Separator Margin="0 8 0 8" />
                    <TextBlock Text="Подсказка: кликните по агенту, чтобы увидеть детали." TextWrapping="Wrap" Opacity="0.7" />
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</UserControl>
