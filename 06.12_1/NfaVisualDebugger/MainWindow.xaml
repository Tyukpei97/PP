<Window x:Class="NfaVisualDebugger.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:viewModels="clr-namespace:NfaVisualDebugger.UI.ViewModels"
        xmlns:rendering="clr-namespace:NfaVisualDebugger.UI.Rendering"
        mc:Ignorable="d"
        Title="Визуальный отладчик НКА и проверка регулярных выражений"
        Width="1350" Height="900"
        Background="#0b1222">
    <Window.DataContext>
        <viewModels:MainViewModel/>
    </Window.DataContext>
    <Window.Resources>
        <rendering:EdgeGeometryConverter x:Key="EdgeGeometryConverter"/>
        <rendering:EdgeLabelPointConverter x:Key="EdgeLabelPointConverter"/>

        <Style x:Key="SectionHeader" TargetType="TextBlock">
            <Setter Property="Foreground" Value="#e5e7eb"/>
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Margin" Value="0,12,0,4"/>
        </Style>

        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

        <DataTemplate x:Key="AutomatonTemplate" DataType="{x:Type viewModels:AutomatonViewModel}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="340"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Margin="0,0,14,0" Padding="12" Background="#111827" CornerRadius="10">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel>
                            <TextBlock Text="{Binding Title}" FontSize="18" FontWeight="Bold" Foreground="#f472b6" Margin="0,0,0,6"/>
                            <TextBlock Style="{StaticResource SectionHeader}" Text="Построение из регулярного выражения"/>
                            <TextBox Text="{Binding RegexText, UpdateSourceTrigger=PropertyChanged}" Height="32" Padding="6" />
                            <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                                <Button Content="Построить НКА" Command="{Binding BuildFromRegexCommand}" Padding="10,6" Margin="0,0,6,0"/>
                                <Button Content="Авторазмещение" Padding="10,6" Click="OnAutoLayoutClick" Tag="{x:Reference AutomatonCanvas}"/>
                            </StackPanel>
                            <TextBlock Foreground="#9ca3af" FontSize="12" Text="Скобки, |, *, +, ?, [abc]. Ошибки покажутся с позицией." Margin="0,4,0,0"/>

                            <TextBlock Style="{StaticResource SectionHeader}" Text="Состояния"/>
                            <TextBlock Foreground="#9ca3af" FontSize="12" Text="ЛКМ по пустому месту — добавить состояние. ЛКМ по кругу — двигать. ПКМ — перетащить на другой круг, чтобы создать переход."/>
                            <StackPanel Margin="0,6,0,0">
                                <TextBlock Text="Имя" Foreground="#e5e7eb"/>
                                <TextBox Text="{Binding SelectedState.Name, TargetNullValue='', UpdateSourceTrigger=PropertyChanged}" Height="28" Padding="6"/>
                                <WrapPanel Margin="0,6,0,0" >
                                    <CheckBox Content="Старт" IsChecked="{Binding SelectedState.IsStart}" Foreground="#e5e7eb" Margin="0,0,8,0"/>
                                    <CheckBox Content="Принимающее" IsChecked="{Binding SelectedState.IsAccept}" Foreground="#e5e7eb"/>
                                </WrapPanel>
                                <WrapPanel Margin="0,6,0,0">
                                    <Button Content="Удалить состояние" Padding="8,4" Click="OnDeleteStateClick" Margin="0,0,6,0"/>
                                    <Button Content="Удалить переход" Padding="8,4" Click="OnDeleteTransitionClick"/>
                                </WrapPanel>
                                <TextBlock Foreground="#9ca3af" FontSize="12" Text="Двойной щелчок по дуге — редактирование метки."/>
                            </StackPanel>

                            <TextBlock Style="{StaticResource SectionHeader}" Text="Симуляция"/>
                            <TextBlock Text="Тестовая строка" Foreground="#e5e7eb"/>
                            <TextBox Text="{Binding InputText, UpdateSourceTrigger=PropertyChanged}" Height="28" Padding="6"/>
                            <WrapPanel Margin="6,8,0,0">
                                <Button Content="Старт" Command="{Binding StartSimulationCommand}" Padding="10,6" Margin="0,0,6,0"/>
                                <Button Content="Шаг вперёд" Command="{Binding StepForwardCommand}" Padding="10,6" Margin="0,0,6,0"/>
                                <Button Content="Шаг назад" Command="{Binding StepBackCommand}" Padding="10,6" Margin="0,0,6,0"/>
                            </WrapPanel>
                            <WrapPanel Margin="6,6,0,0">
                                <Button Content="Пауза" Command="{Binding PauseCommand}" Padding="10,6" Margin="0,0,6,0"/>
                                <Button Content="Сброс" Command="{Binding ResetSimulationCommand}" Padding="10,6"/>
                            </WrapPanel>
                            <TextBlock Text="{Binding StepInfo}" Foreground="#93c5fd" Margin="0,4,0,0"/>
                            <TextBlock Text="{Binding CurrentSymbol, StringFormat=Текущий символ: {0}}" Foreground="#c7d2fe"/>
                            <TextBlock Text="{Binding SimulationMessage}" Foreground="#fbbf24" Margin="0,6,0,0"/>

                            <TextBlock Style="{StaticResource SectionHeader}" Text="Файлы"/>
                            <WrapPanel>
                                <Button Content="Сохранить JSON" Padding="10,6" Click="OnSaveAutomatonClick" Margin="0,0,6,0"/>
                                <Button Content="Загрузить JSON" Padding="10,6" Click="OnLoadAutomatonClick"/>
                            </WrapPanel>
                            <Button Content="Очистить" Margin="0,6,0,0" Command="{Binding ClearCommand}" Padding="10,6"/>

                            <TextBlock Style="{StaticResource SectionHeader}" Text="Статус"/>
                            <TextBlock Text="{Binding Status}" Foreground="#a5f3fc"/>
                        </StackPanel>
                    </ScrollViewer>
                </Border>

                <Border Grid.Column="1" Background="#0f172a" CornerRadius="10" Padding="8">
                    <Grid>
                        <Canvas x:Name="AutomatonCanvas"
                                Background="#0b1222"
                                MouseLeftButtonDown="OnCanvasMouseDown"
                                MouseMove="OnCanvasMouseMove"
                                MouseLeftButtonUp="OnCanvasMouseLeftButtonUp"
                                MouseRightButtonUp="OnCanvasRightButtonUp">
                        </Canvas>

                        <ItemsControl ItemsSource="{Binding Transitions}" IsHitTestVisible="True">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <Canvas/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Grid MouseLeftButtonDown="OnTransitionMouseDown">
                                        <Path StrokeThickness="2.5">
                                            <Path.Style>
                                                <Style TargetType="Path">
                                                    <Setter Property="Stroke" Value="#60d1fa"/>
                                                    <Setter Property="Opacity" Value="0.7"/>
                                                    <Setter Property="StrokeDashArray" Value=""/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsHighlighted}" Value="True">
                                                            <Setter Property="Stroke" Value="#f59e0b"/>
                                                            <Setter Property="Opacity" Value="1"/>
                                                            <Setter Property="StrokeThickness" Value="3.2"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                            <Setter Property="StrokeDashArray" Value="2 2"/>
                                                            <Setter Property="Opacity" Value="1"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Path.Style>
                                            <Path.Data>
                                                <MultiBinding Converter="{StaticResource EdgeGeometryConverter}">
                                                    <Binding Path="From.Position"/>
                                                    <Binding Path="To.Position"/>
                                                    <Binding Path="ParallelIndex"/>
                                                </MultiBinding>
                                            </Path.Data>
                                        </Path>
                                        <Border Background="#1f2937" CornerRadius="4" Padding="4">
                                            <Border.RenderTransform>
                                                <TranslateTransform>
                                                    <TranslateTransform.X>
                                                        <MultiBinding Converter="{StaticResource EdgeLabelPointConverter}" ConverterParameter="X">
                                                            <Binding Path="From.Position"/>
                                                            <Binding Path="To.Position"/>
                                                            <Binding Path="ParallelIndex"/>
                                                        </MultiBinding>
                                                    </TranslateTransform.X>
                                                    <TranslateTransform.Y>
                                                        <MultiBinding Converter="{StaticResource EdgeLabelPointConverter}" ConverterParameter="Y">
                                                            <Binding Path="From.Position"/>
                                                            <Binding Path="To.Position"/>
                                                            <Binding Path="ParallelIndex"/>
                                                        </MultiBinding>
                                                    </TranslateTransform.Y>
                                                </TranslateTransform>
                                            </Border.RenderTransform>
                                            <TextBlock Text="{Binding Label}" Foreground="#f8fafc" FontWeight="Bold"/>
                                        </Border>
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <ItemsControl ItemsSource="{Binding States}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <Canvas/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemContainerStyle>
                                <Style TargetType="ContentPresenter">
                                    <Setter Property="Canvas.Left" Value="{Binding X}"/>
                                    <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                                </Style>
                            </ItemsControl.ItemContainerStyle>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Grid Width="64" Height="64"
                                          MouseLeftButtonDown="OnStateMouseDown"
                                          MouseLeftButtonUp="OnStateMouseUp"
                                          MouseRightButtonDown="OnStateRightButtonDown"
                                          MouseRightButtonUp="OnStateRightButtonUp"
                                          Tag="{x:Reference AutomatonCanvas}">
                                        <Ellipse Fill="#1e293b" Stroke="#38bdf8" StrokeThickness="2.5"/>
                                        <Ellipse Stroke="#f472b6" StrokeThickness="2" Visibility="{Binding IsAccept, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                        <Ellipse Stroke="#10b981" StrokeThickness="3" Visibility="{Binding IsStart, Converter={StaticResource BooleanToVisibilityConverter}}" Margin="4"/>
                                        <Ellipse Stroke="#f59e0b" StrokeThickness="3" Visibility="{Binding IsActive, Converter={StaticResource BooleanToVisibilityConverter}}" Margin="6"/>
                                        <TextBlock Text="{Binding Name}" Foreground="White" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        <ToolTipService.ToolTip>
                                            <StackPanel>
                                                <TextBlock Text="ЛКМ — переместить" Foreground="White"/>
                                                <TextBlock Text="ПКМ — протянуть дугу" Foreground="White"/>
                                            </StackPanel>
                                        </ToolTipService.ToolTip>
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Grid>
                </Border>
            </Grid>
        </DataTemplate>
    </Window.Resources>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <StackPanel Orientation="Horizontal" Grid.Row="0" Margin="0,0,0,8" VerticalAlignment="Center">
            <TextBlock Text="Визуальный отладчик НКА + сравнение двух автоматов" FontSize="22" FontWeight="Bold" Foreground="#f1f5f9"/>
        </StackPanel>

        <TabControl Grid.Row="1" Background="Transparent">
            <TabItem Header="Автомат A">
                <ContentControl Content="{Binding AutomatonA}" ContentTemplate="{StaticResource AutomatonTemplate}"/>
            </TabItem>
            <TabItem Header="Автомат B">
                <ContentControl Content="{Binding AutomatonB}" ContentTemplate="{StaticResource AutomatonTemplate}"/>
            </TabItem>
        </TabControl>

        <Border Grid.Row="2" Background="#111827" Padding="12" CornerRadius="8" Margin="0,8,0,0">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center" >
                <StackPanel>
                    <TextBlock Text="Проверка эквивалентности" Foreground="#f8fafc" FontSize="16" FontWeight="Bold"/>
                    <TextBlock Text="{Binding EquivalenceMessage}" Foreground="#a5f3fc"/>
                    <TextBlock Text="{Binding CounterExample}" Foreground="#fbbf24"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Margin="20,0,0,0">
                    <Button Content="Сравнить A и B" Padding="12,8" Command="{Binding CompareCommand}" Margin="0,0,8,0"/>
                    <Button Content="Сохранить проект" Padding="12,8" Click="OnSaveProjectClick" Margin="0,0,8,0"/>
                    <Button Content="Загрузить проект" Padding="12,8" Click="OnLoadProjectClick"/>
                </StackPanel>
            </StackPanel>
        </Border>
    </Grid>
</Window>
